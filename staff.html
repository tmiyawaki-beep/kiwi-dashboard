<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kiwi スタッフ日報</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Serif+JP:wght@700;900&display=swap">
  <style>
    :root {
      --dark: #0f172a;
      --accent: #6d28d9;
      --green: #10b981;
      --yellow: #f59e0b;
      --red: #ff3b30;
      --blue: #1d5fd4;
      --peach-bg: #fff7f5; --peach-bd: #fdddd8; --peach-col: #c8503e;
      --sky-bg: #eff8ff; --sky-bd: #bfdbfe; --sky-col: #1d5fd4;
      --lav-bg: #f5f3ff; --lav-bd: #ddd6fe; --lav-col: #6d28d9;
      --mint-bg: #f0fdf9; --mint-bd: #a7f3d0; --mint-col: #059669;
      --page-bg: linear-gradient(150deg, #edf0f7 0%, #f3eef8 100%);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans JP', sans-serif; background: var(--page-bg); min-height: 100vh; color: var(--dark); -webkit-font-smoothing: antialiased; }

    /* ===== ログイン ===== */
    #login-screen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 100vh; padding: 24px;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
    }
    .login-logo { font-family: 'Noto Serif JP', serif; font-size: 42px; font-weight: 900; color: white; letter-spacing: -0.04em; }
    .login-sub { font-size: 10px; color: #818cf8; margin-top: 4px; margin-bottom: 40px; font-weight: 700; letter-spacing: 0.2em; text-transform: uppercase; }
    #login-box {
      background: white; border-radius: 28px; padding: 36px 30px; width: 100%; max-width: 340px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.35);
    }
    #login-box h2 { font-size: 12px; font-weight: 900; color: var(--dark); margin-bottom: 24px; text-align: center; letter-spacing: 0.05em; }
    #pin-input {
      width: 100%; padding: 18px; font-size: 28px; font-weight: 900; text-align: center;
      border: 2px solid #e2e8f0; border-radius: 16px; letter-spacing: 16px;
      outline: none; -webkit-text-security: disc; transition: border-color 0.2s;
    }
    #pin-input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(109,40,217,0.1); }
    #login-btn {
      width: 100%; padding: 16px; margin-top: 18px; background: var(--dark); color: white;
      border: none; border-radius: 16px; font-size: 13px; font-weight: 900; cursor: pointer;
      letter-spacing: 0.05em; transition: all 0.2s;
    }
    #login-btn:hover { background: #1e293b; transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
    #login-btn:disabled { opacity: 0.5; transform: none; box-shadow: none; }
    #login-error { color: var(--red); font-size: 11px; font-weight: 700; text-align: center; margin-top: 14px; min-height: 16px; }

    /* ===== ヘッダー ===== */
    #dashboard { display: none; }
    .header {
      background: var(--dark); color: white; padding: 18px 20px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .hdr-left { display: flex; align-items: center; gap: 12px; }
    .hdr-avatar {
      width: 36px; height: 36px; border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), #818cf8);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 900; color: white;
    }
    .hdr-name { font-family: 'Noto Serif JP', serif; font-size: 15px; font-weight: 900; }
    .hdr-store { font-size: 9px; opacity: 0.5; font-weight: 700; margin-top: 2px; letter-spacing: 0.05em; }
    .hdr-logout { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: white; padding: 7px 14px; border-radius: 10px; font-size: 9px; font-weight: 700; cursor: pointer; letter-spacing: 0.05em; }

    .container { padding: 16px; max-width: 640px; margin: 0 auto; }

    /* ===== 月選択 ===== */
    .month-bar { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; }
    .month-bar::-webkit-scrollbar { display: none; }
    .month-btn {
      padding: 9px 18px; border-radius: 12px; border: 1.5px solid #e2e8f0;
      background: white; font-size: 11px; font-weight: 900; color: #94a3b8;
      cursor: pointer; white-space: nowrap; flex-shrink: 0; transition: all 0.2s;
    }
    .month-btn:hover { border-color: #cbd5e1; color: #64748b; }
    .month-btn.active { background: var(--dark); color: white; border-color: var(--dark); box-shadow: 0 4px 12px rgba(15,23,42,0.2); }

    /* ===== 管理者 ===== */
    .admin-bar { margin-bottom: 14px; }
    .admin-bar select {
      width: 100%; padding: 12px 16px; border-radius: 14px; border: 1.5px solid #e2e8f0;
      font-size: 12px; font-weight: 700; background: white; color: var(--dark);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    /* ===== KGI売上カード ===== */
    .kgi-card {
      background: var(--dark); border-radius: 24px; padding: 24px; margin-bottom: 16px;
      color: white; text-align: center; position: relative; overflow: hidden;
      box-shadow: 0 20px 50px -10px rgba(15,23,42,0.3);
    }
    .kgi-card::before {
      content: ''; position: absolute; top: -40px; right: -40px;
      width: 120px; height: 120px; border-radius: 50%;
      background: rgba(255,255,255,0.04);
    }
    .kgi-label { font-size: 8px; font-weight: 900; letter-spacing: 0.2em; text-transform: uppercase; opacity: 0.5; margin-bottom: 8px; }
    .kgi-value { font-family: 'Noto Serif JP', serif; font-size: 36px; font-weight: 900; font-style: italic; line-height: 1; }
    .kgi-sub { font-size: 10px; font-weight: 700; opacity: 0.45; margin-top: 10px; }
    .kgi-pills { display: flex; gap: 8px; justify-content: center; margin-top: 14px; flex-wrap: wrap; }
    .kgi-pill { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 10px; font-size: 9px; font-weight: 700; }

    /* ===== 次回予約率ハイライト ===== */
    .next-res-card {
      background: linear-gradient(135deg, #059669, #10b981);
      border-radius: 22px; padding: 22px 20px; margin-bottom: 16px;
      color: white; position: relative; overflow: hidden;
      box-shadow: 0 12px 30px -6px rgba(5,150,105,0.35);
    }
    .next-res-card::before {
      content: ''; position: absolute; top: -30px; right: -30px;
      width: 100px; height: 100px; border-radius: 50%;
      background: rgba(255,255,255,0.1);
    }
    .next-res-card::after {
      content: ''; position: absolute; bottom: -20px; left: -20px;
      width: 70px; height: 70px; border-radius: 50%;
      background: rgba(255,255,255,0.06);
    }
    .next-res-top { display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 1; }
    .next-res-left {}
    .next-res-label { font-size: 9px; font-weight: 900; letter-spacing: 0.15em; text-transform: uppercase; opacity: 0.8; margin-bottom: 4px; }
    .next-res-value { font-family: 'Noto Serif JP', serif; font-size: 44px; font-weight: 900; font-style: italic; line-height: 1; }
    .next-res-count { font-size: 10px; font-weight: 700; opacity: 0.7; margin-top: 4px; }
    .next-res-icon { font-size: 40px; opacity: 0.25; }
    .next-res-breakdown { display: flex; gap: 10px; margin-top: 14px; position: relative; z-index: 1; }
    .next-res-sub {
      flex: 1; background: rgba(255,255,255,0.15); border-radius: 14px; padding: 10px 12px; text-align: center;
      backdrop-filter: blur(4px);
    }
    .next-res-sub-label { font-size: 8px; font-weight: 900; opacity: 0.8; letter-spacing: 0.1em; }
    .next-res-sub-val { font-family: 'Noto Serif JP', serif; font-size: 20px; font-weight: 900; font-style: italic; margin-top: 2px; }
    .next-res-sub-detail { font-size: 8px; opacity: 0.7; font-weight: 700; margin-top: 2px; }

    /* ===== セクション ===== */
    .section { margin-bottom: 20px; }
    .section-chip {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: 8px; font-weight: 900; letter-spacing: 0.15em; text-transform: uppercase;
      padding: 4px 12px; border-radius: 99px; margin-bottom: 10px;
    }
    .chip-guest { background: var(--peach-bd); color: var(--peach-col); }
    .chip-eff { background: var(--sky-bd); color: var(--sky-col); }
    .chip-add { background: var(--lav-bd); color: var(--lav-col); }
    .chip-fire { background: #fee2e2; color: var(--red); }
    .chip-money { background: var(--mint-bd); color: var(--mint-col); }

    /* ===== KPIカード ===== */
    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kpi-grid.col3 { grid-template-columns: 1fr 1fr 1fr; }
    .kpi {
      border-radius: 18px; padding: 14px 16px; position: relative; overflow: hidden;
      border: 1.5px solid #e2e8f0; background: white;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .kpi:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.07); transform: translateY(-1px); }
    .kpi.guest { background: var(--peach-bg); border-color: var(--peach-bd); }
    .kpi.eff   { background: var(--sky-bg); border-color: var(--sky-bd); }
    .kpi.add   { background: var(--lav-bg); border-color: var(--lav-bd); }
    .kpi.money { background: var(--mint-bg); border-color: var(--mint-bd); }
    .kpi-label { font-size: 8px; font-weight: 900; color: #94a3b8; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 6px; }
    .kpi-label.guest { color: var(--peach-col); }
    .kpi-label.eff { color: var(--sky-col); }
    .kpi-label.add { color: var(--lav-col); }
    .kpi-label.money { color: var(--mint-col); }
    .kpi-val { font-family: 'Noto Serif JP', serif; font-size: 22px; font-weight: 900; font-style: italic; line-height: 1; }
    .kpi-val.guest { color: var(--peach-col); }
    .kpi-val.eff { color: var(--sky-col); }
    .kpi-val.add { color: var(--lav-col); }
    .kpi-val.money { color: var(--mint-col); }
    .kpi-sub { font-size: 8px; color: #94a3b8; font-weight: 700; margin-top: 4px; }

    /* 進捗バー */
    .pbar { height: 6px; background: rgba(0,0,0,0.06); border-radius: 99px; margin-top: 8px; overflow: hidden; }
    .pbar-fill { height: 100%; border-radius: 99px; transition: width 0.8s ease; }
    .pbar-fill.green { background: linear-gradient(90deg, #34d399, #10b981); }
    .pbar-fill.yellow { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
    .pbar-fill.red { background: linear-gradient(90deg, #f87171, #ef4444); }

    /* ===== インセンティブ ===== */
    .incentive-card {
      background: white; border-radius: 22px; padding: 22px 18px;
      box-shadow: 0 4px 16px rgba(15,23,42,0.06); margin-top: 10px;
      border: 1.5px solid var(--mint-bd);
    }
    .incentive-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
    }
    .incentive-badge {
      background: linear-gradient(135deg, #059669, #10b981); color: white;
      padding: 6px 14px; border-radius: 12px; font-size: 10px; font-weight: 900;
      letter-spacing: 0.05em;
    }
    .incentive-type {
      font-size: 9px; font-weight: 700; color: #64748b;
    }
    .incentive-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid #f1f5f9;
    }
    .incentive-row:last-child { border-bottom: none; }
    .incentive-row-label { font-size: 11px; font-weight: 700; color: #475569; }
    .incentive-row-label small { font-size: 9px; color: #94a3b8; font-weight: 500; margin-left: 4px; }
    .incentive-row-val { font-family: 'Noto Serif JP', serif; font-size: 15px; font-weight: 900; color: var(--mint-col); }
    .incentive-total {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 14px; padding: 14px 16px;
      background: linear-gradient(135deg, #f0fdf9, #ecfdf5);
      border-radius: 14px; border: 1.5px solid var(--mint-bd);
    }
    .incentive-total-label { font-size: 12px; font-weight: 900; color: var(--dark); }
    .incentive-total-val { font-family: 'Noto Serif JP', serif; font-size: 22px; font-weight: 900; font-style: italic; color: var(--mint-col); }
    .incentive-note {
      margin-top: 14px; padding: 12px 14px; background: #fffbeb;
      border-radius: 12px; border: 1px solid #fde68a;
      font-size: 10px; font-weight: 600; color: #92400e; line-height: 1.7;
    }
    .incentive-note i { margin-right: 4px; }
    .incentive-tier-info {
      margin-top: 10px; font-size: 9px; color: #94a3b8; font-weight: 600; text-align: center;
    }

    /* ===== 頑張ったこと ===== */
    .effort-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 16px rgba(15,23,42,0.06); margin-top: 10px; }
    .effort-item { padding: 16px 0; border-bottom: 1px solid #f1f5f9; }
    .effort-item:last-child { border-bottom: none; }
    .effort-date {
      font-size: 9px; font-weight: 900; color: white; background: var(--dark);
      padding: 3px 10px; border-radius: 8px; display: inline-block; margin-bottom: 8px;
    }
    .effort-text { font-size: 13px; font-weight: 700; line-height: 1.7; color: #334155; }
    .effort-fb {
      margin-top: 10px; background: linear-gradient(135deg, #faf8ff, #f3eef8);
      border-radius: 14px; padding: 14px 16px; border-left: 3px solid var(--accent);
    }
    .effort-fb-label { font-size: 7px; font-weight: 900; color: var(--accent); text-transform: uppercase; letter-spacing: 0.18em; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
    .effort-fb-text { font-size: 11px; line-height: 1.9; white-space: pre-wrap; color: #475569; }
    .fb-btn {
      margin-top: 8px; padding: 8px 16px; background: var(--accent); color: white;
      border: none; border-radius: 12px; font-size: 10px; font-weight: 700; cursor: pointer;
      transition: all 0.2s; letter-spacing: 0.03em;
    }
    .fb-btn:hover { background: #5b21b6; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(109,40,217,0.3); }
    .fb-btn:disabled { opacity: 0.5; transform: none; box-shadow: none; }

    /* ===== ユーティリティ ===== */
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty { text-align: center; padding: 50px 20px; color: #94a3b8; }
    .empty i { font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.4; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15,23,42,0.7); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center; z-index: 999;
    }
    .loading-box { background: white; border-radius: 24px; padding: 36px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    .loading-box .spinner { width: 32px; height: 32px; border-width: 3px; border-color: rgba(109,40,217,0.15); border-top-color: var(--accent); }
    .loading-box p { margin-top: 14px; font-size: 12px; font-weight: 700; color: #64748b; }
  </style>
</head>
<body>

<!-- ===== ログイン ===== -->
<div id="login-screen">
  <p class="login-logo">Kiwi</p>
  <p class="login-sub">Staff Dashboard</p>
  <div id="login-box">
    <h2><i class="fas fa-lock" style="margin-right:6px; color:var(--accent)"></i> PINコードを入力</h2>
    <input type="password" id="pin-input" maxlength="4" placeholder="----" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    <button id="login-btn" onclick="doLogin()">ログイン</button>
    <p id="login-error"></p>
  </div>
</div>

<!-- ===== ダッシュボード ===== -->
<div id="dashboard">
  <div class="header">
    <div class="hdr-left">
      <div class="hdr-avatar" id="hdr-avatar"></div>
      <div>
        <p class="hdr-name" id="hdr-name"></p>
        <p class="hdr-store" id="hdr-store"></p>
      </div>
    </div>
    <button class="hdr-logout" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> ログアウト</button>
  </div>

  <div class="container">
    <div id="admin-bar" class="admin-bar" style="display:none">
      <select id="admin-staff-select" onchange="renderDashboard()">
        <option value="">--- スタッフを選択 ---</option>
      </select>
    </div>
    <div class="month-bar" id="month-bar"></div>
    <div id="data-area"></div>
  </div>
</div>

<div id="loading-overlay" class="loading-overlay" style="display:none">
  <div class="loading-box"><div class="spinner"></div><p id="loading-text">読み込み中...</p></div>
</div>

<script>
  var GAS_URL = 'https://script.google.com/macros/s/AKfycbyLJLwnzWMJbFX_5nanQZC5hVQGz7edy1jXgMZnGxZF6bZcg4DMFCD_bhjR6quBi_QWAA/exec';
  var _pin='', _auth=null, _nippo=null, _selectedMonth='', _selectedStaff='';

  document.getElementById('pin-input').addEventListener('keyup', function(e) { if(e.key==='Enter') doLogin(); });

  function showLoading(t){ document.getElementById('loading-text').textContent=t||'読み込み中...'; document.getElementById('loading-overlay').style.display='flex'; }
  function hideLoading(){ document.getElementById('loading-overlay').style.display='none'; }

  function fetchAPI(action,params,cb){
    var url=GAS_URL+'?action='+action;
    for(var k in params){ if(params[k]) url+='&'+k+'='+encodeURIComponent(params[k]); }
    fetch(url).then(function(r){ return r.json(); }).then(cb).catch(function(e){ cb({error:String(e)}); });
  }

  function doLogin(){
    var pin=document.getElementById('pin-input').value.trim(); if(!pin) return; _pin=pin;
    var btn=document.getElementById('login-btn'), err=document.getElementById('login-error');
    btn.disabled=true; btn.innerHTML='<span class="spinner"></span>'; err.textContent='';
    fetchAPI('staffAuth',{pin:pin},function(d){
      btn.disabled=false; btn.innerHTML='ログイン';
      if(d.valid){ _auth={staffName:d.staffName,role:d.role}; loadData(); }
      else{ err.textContent=d.error||'PINが正しくありません'; document.getElementById('pin-input').value=''; document.getElementById('pin-input').focus(); }
    });
  }

  function loadData(){
    showLoading('データ読み込み中...');
    fetchAPI('staffData',{pin:_pin},function(d){
      hideLoading();
      if(d.error){ alert('エラー: '+d.error); return; }
      _nippo=d.staffNippo; showDashboard();
    });
  }

  function showDashboard(){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('dashboard').style.display='block';
    var initial = _auth.staffName.charAt(0);
    document.getElementById('hdr-avatar').textContent = initial;
    document.getElementById('hdr-name').textContent=_auth.staffName+(_auth.role==='admin'?' (Admin)':'');
    document.getElementById('hdr-store').textContent='';
    if(_auth.role==='admin' && _nippo && _nippo.staffList && _nippo.staffList.length>0){
      document.getElementById('admin-bar').style.display='block';
      var sel=document.getElementById('admin-staff-select');
      sel.innerHTML='<option value="">--- スタッフを選択 ---</option>';
      _nippo.staffList.forEach(function(s){ var o=document.createElement('option'); o.value=s.name; o.textContent=s.name+'（'+s.store+'）'; sel.appendChild(o); });
      if(_nippo.staffList.length===1) sel.value=_nippo.staffList[0].name;
    }
    buildMonthBar(); renderDashboard();
  }

  function buildMonthBar(){
    var months={};
    if(_nippo&&_nippo.monthlyData){ for(var k in _nippo.monthlyData){ months[k.split('___')[0]]=true; } }
    var sorted=Object.keys(months).sort().reverse();
    var bar=document.getElementById('month-bar'); bar.innerHTML='';
    if(!sorted.length){ _selectedMonth=''; return; }
    _selectedMonth=sorted[0];
    sorted.forEach(function(m){
      var btn=document.createElement('button');
      btn.className='month-btn'+(m===_selectedMonth?' active':'');
      btn.textContent=m.replace('-','年')+'月';
      btn.onclick=function(){ _selectedMonth=m; bar.querySelectorAll('.month-btn').forEach(function(b){b.classList.remove('active');}); btn.classList.add('active'); renderDashboard(); };
      bar.appendChild(btn);
    });
  }

  /* ===== インセンティブ計算 ===== */
  function calcIncentive(storeName, totalSales, productSales, opSales) {
    var prefix = (storeName || '').charAt(0).toLowerCase();
    var isM = (prefix === 'm');
    var salesIncentive = 0;
    var tierLabel = '';

    if (isM) {
      // most eyes テーブル
      if (totalSales >= 1100000) { salesIncentive = Math.round(totalSales * 0.11); tierLabel = '11%'; }
      else if (totalSales >= 1000000) { salesIncentive = 90000; tierLabel = '¥1,000,000 → 9%'; }
      else if (totalSales >= 950000)  { salesIncentive = 76000; tierLabel = '¥950,000 → 8%'; }
      else if (totalSales >= 900000)  { salesIncentive = 54000; tierLabel = '¥900,000 → 6%'; }
      else if (totalSales >= 850000)  { salesIncentive = 42500; tierLabel = '¥850,000 → 5%'; }
      else if (totalSales >= 800000)  { salesIncentive = 24000; tierLabel = '¥800,000 → 3%'; }
      else if (totalSales >= 750000)  { salesIncentive = 15000; tierLabel = '¥750,000 → 2%'; }
      else { tierLabel = '¥750,000未満'; }
    } else {
      // SSIN / LUMISS テーブル
      if (totalSales >= 1100000) { salesIncentive = Math.round(totalSales * 0.10); tierLabel = '10%'; }
      else if (totalSales >= 1000000) { salesIncentive = 90000; tierLabel = '¥1,000,000 → 9%'; }
      else if (totalSales >= 950000)  { salesIncentive = 76000; tierLabel = '¥950,000 → 8%'; }
      else if (totalSales >= 900000)  { salesIncentive = 54000; tierLabel = '¥900,000 → 6%'; }
      else if (totalSales >= 850000)  { salesIncentive = 42500; tierLabel = '¥850,000 → 5%'; }
      else if (totalSales >= 800000)  { salesIncentive = 32000; tierLabel = '¥800,000 → 4%'; }
      else if (totalSales >= 750000)  { salesIncentive = 22500; tierLabel = '¥750,000 → 3%'; }
      else if (totalSales >= 700000)  { salesIncentive = 14000; tierLabel = '¥700,000 → 2%'; }
      else if (totalSales >= 650000)  { salesIncentive = 6500;  tierLabel = '¥650,000 → 1%'; }
      else { tierLabel = '¥650,000未満'; }
    }

    var productIncentive = Math.round((productSales || 0) * 0.05);
    var opIncentive = Math.round((opSales || 0) * 0.05);
    var total = salesIncentive + productIncentive + opIncentive;

    return {
      storeType: isM ? 'most eyes' : 'SSIN / LUMISS',
      isM: isM,
      salesIncentive: salesIncentive,
      productIncentive: productIncentive,
      opIncentive: opIncentive,
      total: total,
      tierLabel: tierLabel
    };
  }

  function renderDashboard(){
    var area=document.getElementById('data-area');
    var ts=_auth.role==='admin'?document.getElementById('admin-staff-select').value:_auth.staffName;
    _selectedStaff=ts;
    if(!ts||!_selectedMonth||!_nippo){
      area.innerHTML='<div class="empty"><i class="fas fa-user-clock"></i><p style="font-size:14px;font-weight:900">スタッフと月を選択してください</p></div>'; return;
    }
    var d=_nippo.monthlyData[_selectedMonth+'___'+ts];
    if(!d){ area.innerHTML='<div class="empty"><i class="fas fa-search"></i><p style="font-size:14px;font-weight:900">データがありません</p><p style="font-size:10px;margin-top:8px;opacity:0.6">'+ts+' / '+_selectedMonth.replace('-','年')+'月</p></div>'; return; }
    document.getElementById('hdr-store').textContent=d.storeName+' / '+_selectedMonth.replace('-','年')+'月';

    var totalGuests = d.totalGuests || 0;
    var avgUnitPrice = totalGuests > 0 ? Math.round(d.totalSales / totalGuests) : 0;

    var h='<div class="fade-in">';

    // ===== KGI 売上カード =====
    h+='<div class="kgi-card"><p class="kgi-label">Monthly Sales</p>'
      +'<p class="kgi-value">¥'+num(d.totalSales)+'</p>'
      +'<p class="kgi-sub">出勤 '+d.workDays+'日 ／ 日平均 ¥'+num(Math.round(d.avgSalesPerDay))+'</p>'
      +'<div class="kgi-pills">'
      +'<span class="kgi-pill"><i class="fas fa-user-plus" style="margin-right:4px"></i>新規 '+d.newGuests+'</span>'
      +'<span class="kgi-pill"><i class="fas fa-redo" style="margin-right:4px"></i>再来 '+d.repeatGuests+'</span>'
      +'<span class="kgi-pill"><i class="fas fa-users" style="margin-right:4px"></i>合計 '+totalGuests+'人</span>'
      +'<span class="kgi-pill"><i class="fas fa-coins" style="margin-right:4px"></i>客単価 ¥'+num(avgUnitPrice)+'</span>'
      +'</div></div>';

    // ===== 次回予約率ハイライト =====
    var nextResTotal = (d.newNextRes||0) + (d.repeatNextRes||0);
    h+='<div class="next-res-card">'
      +'<div class="next-res-top">'
      +'<div class="next-res-left">'
      +'<p class="next-res-label"><i class="fas fa-calendar-check" style="margin-right:4px"></i>次回予約率</p>'
      +'<p class="next-res-value">'+pct(d.nextResRate)+'</p>'
      +'<p class="next-res-count">'+nextResTotal+' / '+totalGuests+'客</p>'
      +'</div>'
      +'<div class="next-res-icon"><i class="fas fa-calendar-check"></i></div>'
      +'</div>'
      +'<div class="next-res-breakdown">'
      +'<div class="next-res-sub"><p class="next-res-sub-label">新規</p><p class="next-res-sub-val">'+pct(d.newNextResRate)+'</p><p class="next-res-sub-detail">'+d.newNextRes+' / '+d.newGuests+'人</p></div>'
      +'<div class="next-res-sub"><p class="next-res-sub-label">再来</p><p class="next-res-sub-val">'+pct(d.repeatNextResRate)+'</p><p class="next-res-sub-detail">'+d.repeatNextRes+' / '+d.repeatGuests+'人</p></div>'
      +'</div></div>';

    // ===== 客数セクション =====
    h+='<div class="section"><span class="section-chip chip-guest"><i class="fas fa-users"></i> 客数</span>'
      +'<div class="kpi-grid">'
      +kpi('新規客数',d.newGuests+'人','全体の '+pct(totalGuests>0?d.newGuests/totalGuests:0),'guest')
      +kpi('再来客数',d.repeatGuests+'人','再来率 '+pct(d.repeatRate),'guest',d.repeatRate,0.5)
      +kpi('回数券率',pct(d.ticketRate),'初回'+d.firstTicket+' 継続'+d.continueTicket,'guest',d.ticketRate,0.2)
      +kpi('総客数',totalGuests+'人','日平均 '+((d.avgGuestsPerDay||0).toFixed(1))+'人','guest')
      +'</div></div>';

    // ===== 単価セクション =====
    h+='<div class="section"><span class="section-chip chip-add"><i class="fas fa-yen-sign"></i> 単価・売上内訳</span>'
      +'<div class="kpi-grid">'
      +kpi('客単価','¥'+num(avgUnitPrice),'総売上 ÷ 総客数','add')
      +kpi('物販売上','¥'+num(d.productSales),'物販率 '+pct(d.productRate),'add',d.productRate,0.10)
      +kpi('OP売上','¥'+num(d.opSales),'口コミ星5: '+d.reviewStar5+'件','add')
      +kpi('回数券売上','¥'+num(d.ticketSales),'初回'+d.firstTicket+'件 継続'+d.continueTicket+'件','add')
      +'</div></div>';

    // ===== インセンティブセクション =====
    var inc = calcIncentive(d.storeName, d.totalSales, d.productSales, d.opSales);
    h+='<div class="section"><span class="section-chip chip-money"><i class="fas fa-hand-holding-usd"></i> 想定インセンティブ</span>';
    h+='<div class="incentive-card">';
    h+='<div class="incentive-header">'
      +'<span class="incentive-badge"><i class="fas fa-calculator" style="margin-right:4px"></i>歩合計算</span>'
      +'<span class="incentive-type">'+esc(inc.storeType)+' テーブル適用</span>'
      +'</div>';

    h+='<div class="incentive-row">'
      +'<span class="incentive-row-label">売上歩合<small>'+esc(inc.tierLabel)+'</small></span>'
      +'<span class="incentive-row-val">¥'+num(inc.salesIncentive)+'</span></div>';

    h+='<div class="incentive-row">'
      +'<span class="incentive-row-label">物販歩合<small>5%</small></span>'
      +'<span class="incentive-row-val">¥'+num(inc.productIncentive)+'</span></div>';

    h+='<div class="incentive-row">'
      +'<span class="incentive-row-label">OP歩合<small>5%</small></span>'
      +'<span class="incentive-row-val">¥'+num(inc.opIncentive)+'</span></div>';

    h+='<div class="incentive-row" style="opacity:0.5">'
      +'<span class="incentive-row-label">店長手当<small>該当者のみ</small></span>'
      +'<span class="incentive-row-val" style="font-size:11px;color:#94a3b8">¥20,000</span></div>';

    h+='<div class="incentive-row" style="opacity:0.5">'
      +'<span class="incentive-row-label">指名料<small>100% ※データ外</small></span>'
      +'<span class="incentive-row-val" style="font-size:11px;color:#94a3b8">---</span></div>';

    h+='<div class="incentive-total">'
      +'<span class="incentive-total-label"><i class="fas fa-coins" style="margin-right:6px;color:var(--mint-col)"></i>想定合計（売上+物販+OP）</span>'
      +'<span class="incentive-total-val">¥'+num(inc.total)+'</span></div>';

    h+='<div class="incentive-tier-info">'
      +'現在の売上 ¥'+num(d.totalSales)+' → '+esc(inc.tierLabel)+'</div>';

    h+='<div class="incentive-note">'
      +'<i class="fas fa-exclamation-triangle"></i>'
      +'上記は日報データに基づく概算です。集計方法や締め日の違いにより、実際の給与明細とは金額が異なる場合があります。'
      +'店長手当（¥20,000）・指名料（100%）は別途加算されます。</div>';

    h+='</div></div>';

    // ===== 頑張ったこと =====
    h+='<div class="section"><span class="section-chip chip-fire"><i class="fas fa-fire"></i> 頑張ったこと</span>';
    h+='<div class="effort-card">';
    if(d.efforts&&d.efforts.length>0){
      d.efforts.slice().reverse().forEach(function(e,i){
        h+='<div class="effort-item"><span class="effort-date">'+e.date+'</span>'
          +'<p class="effort-text">'+esc(e.text)+'</p>'
          +'<div id="fb-'+i+'"></div>'
          +'<button class="fb-btn" id="fb-btn-'+i+'" onclick="getAiFeedback('+i+',\''+escJs(ts)+'\',\''+escJs(e.text)+'\',\''+e.date+'\')">'
          +'<i class="fas fa-robot" style="margin-right:4px"></i>AIフィードバック</button></div>';
      });
    } else {
      h+='<p style="text-align:center;color:#94a3b8;font-size:11px;padding:24px 0"><i class="fas fa-inbox" style="font-size:24px;display:block;margin-bottom:8px;opacity:0.3"></i>記録なし</p>';
    }
    h+='</div></div>';

    h+='</div>';
    area.innerHTML=h;
  }

  function kpi(label,value,sub,type,rate,threshold){
    var barHtml='';
    if(rate!==undefined){
      var pctW=Math.min(Math.round(rate*100),100);
      var cls=threshold?(rate>=threshold*1.3?'green':rate>=threshold?'yellow':'red'):'green';
      barHtml='<div class="pbar"><div class="pbar-fill '+cls+'" style="width:'+pctW+'%"></div></div>';
    }
    return '<div class="kpi '+type+'">'
      +'<p class="kpi-label '+type+'">'+label+'</p>'
      +'<p class="kpi-val '+type+'">'+value+'</p>'
      +'<p class="kpi-sub">'+sub+'</p>'
      +barHtml+'</div>';
  }

  function pct(v){ return Math.round((v||0)*100)+'%'; }
  function num(v){ return (v||0).toLocaleString(); }

  function getAiFeedback(i,name,effort,date){
    var btn=document.getElementById('fb-btn-'+i), fb=document.getElementById('fb-'+i);
    if(!btn||!fb) return;
    btn.disabled=true; btn.innerHTML='<span class="spinner" style="border-color:rgba(255,255,255,0.3);border-top-color:white"></span> 分析中...';
    fetchAPI('staffFeedback',{pin:_pin,staffName:name,effort:effort,date:date},function(d){
      btn.disabled=false; btn.innerHTML='<i class="fas fa-robot" style="margin-right:4px"></i>再取得';
      if(d.feedback){ fb.innerHTML='<div class="effort-fb"><p class="effort-fb-label"><i class="fas fa-robot"></i> AI Coach</p><p class="effort-fb-text">'+esc(d.feedback)+'</p></div>'; }
      else{ fb.innerHTML='<p style="color:var(--red);font-size:10px;margin-top:4px">'+(d.error||'エラー')+'</p>'; }
    });
  }

  function doLogout(){
    _pin=''; _auth=null; _nippo=null;
    document.getElementById('dashboard').style.display='none';
    document.getElementById('login-screen').style.display='flex';
    document.getElementById('pin-input').value='';
    document.getElementById('login-error').textContent='';
    document.getElementById('data-area').innerHTML='';
    document.getElementById('admin-bar').style.display='none';
  }

  function esc(s){ var d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
  function escJs(s){ return s.replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
</script>
</body>
</html>
